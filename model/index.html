<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClashMate - Elixir Cost Predictor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <h1 class="text-gradient">ClashMate</h1>
        <p class="subtitle">Elixir Cost Predictor</p>

        <div class="main-grid">
            <!-- Input Form -->
            <div class="card">
                <h2>Card Statistics</h2>

                <form id="predictForm">
                    <div class="form-group">
                        <label for="type">Card Type</label>
                        <select id="type" required>
                            <option value="Troop">Troop</option>
                            <option value="Spell">Spell</option>
                            <option value="Defensive Building">Defensive Building</option>
                            <option value="Passive Building">Passive Building</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hitpoints">Hitpoints</label>
                        <input type="number" id="hitpoints" placeholder="1500" min="0" step="1">
                    </div>

                    <div class="form-group">
                        <label for="damage">Damage</label>
                        <input type="number" id="damage" placeholder="200" min="0" step="1">
                    </div>

                    <div class="form-group">
                        <label for="hitSpeed">Hit Speed</label>
                        <input type="number" id="hitSpeed" placeholder="1.5" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="dps">DPS</label>
                        <input type="number" id="dps" placeholder="Calculated automatically" min="0" step="1" readonly>
                    </div>

                    <div class="form-group">
                        <label for="range">Range</label>
                        <input type="number" id="range" placeholder="5.5" min="0" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="count">Count</label>
                        <input type="number" id="count" placeholder="1" min="1" step="1" value="1">
                    </div>

                    <div class="button-group">
                        <button type="submit" class="card-button-primary">Predict</button>
                        <button type="button" class="card-button-secondary" onclick="clearForm()">Clear</button>
                    </div>
                </form>

                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p>Calculating...</p>
                </div>
            </div>

            <!-- Results -->
            <div class="card">
                <h2>Results</h2>
                <div class="empty-state" id="emptyState">
                    <p>Enter card statistics and click Predict to see results</p>
                </div>
                <div class="result-section" id="results">
                    <div class="result-main">
                        <div class="result-value" id="predictedValue">-</div>
                        <div class="result-label">Elixir Cost</div>
                    </div>
                    <div class="confidence-range" id="confidenceRange">
                        Range: - to -
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="minCost">1</div>
                            <div class="stat-label">Min in Dataset</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="maxCost">10</div>
                            <div class="stat-label">Max in Dataset</div>
                        </div>
                    </div>
                </div>
                <div class="gauge-container" id="gaugeContainer">
                    <canvas id="gaugeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Distribution Chart -->
        <div class="card">
            <h2>Distribution</h2>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let distributionChart = null;
        let gaugeChart = null;
        let allCardsData = [];

        // Validation and input feedback
        function validateInput(input) {
            const value = parseFloat(input.value);
            if (input.value && value < 0) {
                input.classList.add('invalid');
                return false;
            } else {
                input.classList.remove('invalid');
                return true;
            }
        }

        // Auto-calculate DPS when damage or hit speed changes
        function calculateDPS() {
            const damage = parseFloat(document.getElementById('damage').value) || 0;
            const hitSpeed = parseFloat(document.getElementById('hitSpeed').value) || 0;

            if (damage > 0 && hitSpeed > 0) {
                const dps = Math.round(damage / hitSpeed);
                document.getElementById('dps').value = dps;
                document.getElementById('dps').classList.add('auto-filled');
                setTimeout(() => {
                    document.getElementById('dps').classList.remove('auto-filled');
                }, 1000);
            } else {
                document.getElementById('dps').value = '';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Clear form
        function clearForm() {
            document.getElementById('predictForm').reset();
            document.getElementById('results').classList.remove('show');
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('gaugeContainer').style.display = 'none';
            document.getElementById('count').value = 1;
            document.getElementById('dps').value = '';

            // Reset chart highlight
            if (distributionChart) {
                distributionChart.data.datasets[0].backgroundColor = 'rgba(102, 126, 234, 0.6)';
                distributionChart.update();
            }
        }

        // Add event listeners for validation and auto-calc
        document.addEventListener('DOMContentLoaded', function () {
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                if (input.id !== 'dps') {
                    input.addEventListener('input', function () {
                        validateInput(this);
                    });
                }
            });

            document.getElementById('damage').addEventListener('input', calculateDPS);
            document.getElementById('hitSpeed').addEventListener('input', calculateDPS);

            // Add keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // Ctrl/Cmd + Enter to submit
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    document.getElementById('predictForm').requestSubmit();
                }
                // Escape to clear
                if (e.key === 'Escape') {
                    clearForm();
                }
            });
        });

        // Load all cards data on page load
        async function loadCardsData() {
            try {
                const response = await fetch('/cards');
                allCardsData = await response.json();
                createDistributionChart();
            } catch (error) {
                console.error('Error loading cards data:', error);
            }
        }

        // Create distribution chart
        function createDistributionChart() {
            const ctx = document.getElementById('distributionChart');

            // Count cards by elixir cost
            const costCounts = {};
            allCardsData.forEach(card => {
                costCounts[card.elixir] = (costCounts[card.elixir] || 0) + 1;
            });

            const costs = Object.keys(costCounts).sort((a, b) => a - b);
            const counts = costs.map(cost => costCounts[cost]);

            if (distributionChart) {
                distributionChart.destroy();
            }

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: costs.map(c => c + ' Elixir'),
                    datasets: [{
                        label: 'Number of Cards',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Card Distribution by Elixir Cost'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Create gauge chart
        function createGaugeChart(value, min, max) {
            const ctx = document.getElementById('gaugeChart');

            if (gaugeChart) {
                gaugeChart.destroy();
            }

            const data = {
                datasets: [{
                    data: [value, max - value],
                    backgroundColor: [
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(230, 230, 230, 0.3)'
                    ],
                    borderWidth: 0
                }]
            };

            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
        }

        // Handle form submission
        document.getElementById('predictForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate at least one stat is filled
            const hasInput = ['hitpoints', 'damage', 'range'].some(id =>
                document.getElementById(id).value !== ''
            );

            if (!hasInput) {
                showNotification('Please enter at least one stat', 'error');
                return;
            }

            const formData = {
                type: document.getElementById('type').value,
                hitpoints: document.getElementById('hitpoints').value,
                damage: document.getElementById('damage').value,
                hitSpeed: document.getElementById('hitSpeed').value,
                dps: document.getElementById('dps').value,
                range: document.getElementById('range').value,
                count: document.getElementById('count').value
            };

            // Show loader, hide empty state
            document.getElementById('loader').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('gaugeContainer').style.display = 'none';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.error) {
                    showNotification(result.error, 'error');
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                // Update results
                document.getElementById('predictedValue').textContent = result.predicted_elixir.toFixed(1);
                document.getElementById('confidenceRange').textContent =
                    `Range: ${result.confidence_lower.toFixed(1)} to ${result.confidence_upper.toFixed(1)} elixir`;

                // Show results with animation
                setTimeout(() => {
                    document.getElementById('results').classList.add('show');
                    document.getElementById('gaugeContainer').style.display = 'block';
                }, 100);

                // Create gauge chart
                createGaugeChart(result.predicted_elixir, 1, 10);

                // Highlight the predicted cost in distribution chart
                updateDistributionHighlight(result.predicted_elixir);

                // Success notification
                showNotification('Prediction complete!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to connect to server. Please make sure it\'s running.', 'error');
                document.getElementById('emptyState').style.display = 'block';
            } finally {
                document.getElementById('loader').classList.remove('show');
            }
        });

        // Update distribution chart with prediction highlight
        function updateDistributionHighlight(predictedCost) {
            if (!distributionChart) return;

            const roundedCost = Math.round(predictedCost);
            const colors = distributionChart.data.labels.map((label, index) => {
                const cost = parseInt(label);
                return cost === roundedCost ?
                    'rgba(245, 87, 108, 0.8)' :
                    'rgba(102, 126, 234, 0.6)';
            });

            distributionChart.data.datasets[0].backgroundColor = colors;
            distributionChart.update();
        }

        // Load data on page load
        loadCardsData();
    </script>
</body>

</html>